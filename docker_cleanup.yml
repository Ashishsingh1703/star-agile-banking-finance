---
- name: Stop and remove Docker containers
  hosts: all
  tasks:
    - name: Check if there are running containers
      shell: docker ps -q
      register: running_containers
      ignore_errors: true  # Ignore errors if no containers are running

    - name: Stop running containers if any
      shell: docker stop {{ item }}
      become: yes
      loop: "{{ running_containers.stdout_lines }}"
      when: running_containers.stdout_lines | length > 0

    - name: Remove all images
      shell: docker rmi -f $(docker images -q)
      become: yes

    - name: Stop all containers
      shell: docker stop $(docker ps -aq)
      become: yes
